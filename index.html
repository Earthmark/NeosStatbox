<html>

<head>
    <style type="text/css">
        #graph-container {
            width: 100%;
            height: auto;
            margin: auto;
        }

        #file-selector {
            position: fixed;
            margin: 24;
            z-index: 1;
        }

        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <input type="file" id="file-selector" accept=".json">
    <div id="graph-container"></div>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
        const fileSelector = document.getElementById('file-selector');
        fileSelector.addEventListener('change', changeEvent => {

            const reader = new FileReader();
            reader.addEventListener('load', loadEvent => {
                const raw = JSON.parse(loadEvent.target.result);

                const recordColor = '#000000';
                const worldColor = '#006600';
                const assetColor = '#FF00FF';

                // fold result into a node tree.
                const nodes = {};
                const edges = [];
                raw.forEach(record => {
                    nodes[record.id] =
                    {
                        id: record.id,
                        label: (record.path ? record.path + "/" : "") + record.name,
                        type: record.recordType,
                        x: 0,
                        y: 0,
                        size: 5
                    };

                    record.neosDBmanifest.forEach(asset => {
                        if (nodes[asset.hash] === undefined) {
                            nodes[asset.hash] = {
                                id: asset.hash,
                                label: `${asset.hash}${"\n"}${asset.bytes} bytes`,
                                type: "asset",
                                x: 0,
                                y: 0,
                                size: Math.log(asset.bytes)
                            };
                        }
                        edges.push({
                            value: 2,
                            source: record.id,
                            target: asset.hash
                        });
                    });
                });

                const graph = {
                    nodes: Object.values(nodes),
                    edges: edges
                };
                console.log(graph);

                const simulation = d3.forceSimulation(graph.nodes)
                    .force("link", d3.forceLink(graph.edges).id(d => d.id))
                    .force("charge", d3.forceManyBody())
                    .force("x", d3.forceX())
                    .force("y", d3.forceY());

                const height = 2000;
                const width = 2000;
                const svg = d3.create("svg")
                    .attr("viewBox", [-width / 2, -height / 2, width, height])
                    .attr("preserveAspectRatio", "none");

                const edge = svg.append("g")
                    .attr("stroke", "#999")
                    .attr("stroke-opacity", 0.6)
                    .selectAll("line")
                    .data(graph.edges)
                    .join("line")
                    .attr("stroke-width", d => d < 1 ? 1 : Math.sqrt(d.value));

                function dragStarted(d) {
                    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function dragged(d) {
                    d.fx = d3.event.x;
                    d.fy = d3.event.y;
                }

                function dragEnded(d) {
                    if (!d3.event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }

                const drag = d3.drag()
                    .on("start", dragStarted)
                    .on("drag", dragged)
                    .on("end", dragEnded);

                const scale = d3.scaleOrdinal(d3.schemeCategory10);

                const node = svg.append("g")
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 1.5)
                    .selectAll("circle")
                    .data(graph.nodes)
                    .join("circle")
                    .attr("r", d => d.size)
                    .attr("fill", d => scale(d.type))
                    .call(drag);

                node.append("title")
                    .text(d => d.id);

                simulation.on("tick", () => {
                    edge
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("cx", d => d.x)
                        .attr("cy", d => d.y);
                });

                //invalidation.then(() => simulation.stop());

                document.getElementById("graph-container").appendChild(svg.node());

                // If we get to this point, we loaded the graph successfully.
                // Disable the selector as a signal for that.
                fileSelector.style.display = "none";
            });
            reader.readAsText(changeEvent.target.files[0]);
        });

    </script>
</body>

</html>